# User Story 008.2: Implement Save Entry Server Action - Part 2 (Form Data and User ID)

## 1. Title

Implement form data extraction and user ID retrieval in the `saveDiaryEntry` Server Action.

## 2. Goal

To implement the logic within the `saveDiaryEntry` Server Action to extract data from the `FormData` object and retrieve the current user's ID from Firebase Authentication.

## 3. Description

As a junior developer, I need to implement the data processing part of the `saveDiaryEntry` Server Action. This involves extracting all the necessary form field values from the `FormData` object passed to the Server Action and securely retrieving the ID of the currently authenticated user.

## 4. Technical Details

- **Form Data Extraction:**
  - Use `formData.get('fieldName') as string;` to extract values for all relevant form fields: `foodEaten`, `description`, `emotions`, `location`, `company`, `behavior`, `skippedMeal`, `date`, `time`, `entryType`.
  - Ensure correct data types are handled (e.g., convert 'skippedMeal' to boolean if needed).
- **User ID Retrieval:**
  - Use `auth.currentUser?.uid` to get the current user's UID from Firebase Authentication.
  - Implement error handling for cases where the user is not authenticated (e.g., return an error state from the Server Action).

## 5. Steps to Implement

1. **Open `saveDiaryEntry` Function:**
   - Open the file containing the `saveDiaryEntry` Server Action (e.g., `src/components/EntryForm.tsx` or `src/app/actions.ts`).
2. **Implement Form Data Extraction:**
   - Inside the `saveDiaryEntry` function, add code to extract all the necessary form field values from the `formData` object.
   - Example:
     ```typescript
     // Inside saveDiaryEntry function
     const foodEaten = formData.get("foodEaten") as string;
     const description = formData.get("description") as string;
     const emotions = formData.getAll("emotions") as string[]; // For multi-select Autocomplete
     const location = formData.get("location") as string;
     const company = formData.get("company") as string;
     const behavior = formData.getAll("behavior") as string[]; // For multi-select Autocomplete
     const skippedMeal = formData.get("skippedMeal"); // Switch value
     const date = formData.get("date") as string;
     const time = formData.get("time") as string;
     const entryType = formData.get("entryType") as string;
     const skippedMealBoolean = skippedMeal === "on"; // Convert switch to boolean
     ```
3. **Implement User ID Retrieval and Error Handling:**

   - Add code to retrieve the current user's ID: `const userId = auth.currentUser?.uid;`.
   - Add a check to ensure `userId` is valid (user is authenticated).
   - If `userId` is missing, log an error message and return an error state from the Server Action (e.g., `{ error: 'User not authenticated' }`).

     ```typescript
     // Inside saveDiaryEntry function
     const userId = auth.currentUser?.uid; // Get current user ID

     if (!userId) {
       console.error("User not authenticated.");
       return { error: "User not authenticated" }; // Return error state
     }
     ```

## 6. Acceptance Criteria

- Form data extraction is implemented in the `saveDiaryEntry` Server Action for all relevant form fields, correctly retrieving values from the `FormData` object.
- User ID retrieval is implemented using `auth.currentUser?.uid`.
- Error handling is implemented to check for user authentication and return an error state if the user is not authenticated.
- The Server Action is now capable of extracting form data and obtaining the user ID, preparing for the Firestore data saving logic in the next part.

## 7. Notes

- This user story focuses on data extraction and user ID retrieval within the Server Action.
- The next user story (008.3) will implement the Firestore data saving logic using the extracted data and user ID.
- Data validation and sanitization should be considered in future user stories.
