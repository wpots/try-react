# User Story 008.3: Implement Save Entry Server Action - Part 3 (Firestore Logic and Error Handling)

## 1. Title

Implement Firestore data saving logic and error handling in the `saveDiaryEntry` Server Action.

## 2. Goal

To implement the Firestore data saving logic within the `saveDiaryEntry` Server Action and add robust error handling for database operations.

## 3. Description

As a junior developer, I need to complete the implementation of the `saveDiaryEntry` Server Action by adding the code that actually saves the extracted form data to the Firestore database. This includes writing the data to the `diaryEntries` collection and implementing proper error handling to manage potential issues during database interactions.

## 4. Technical Details

- **Firestore Data Saving:**
  - Use `addDoc(collection(db, "diaryEntries"), { ... });` to save the diary entry data to Firestore.
  - Include all extracted form fields and the `userId` in the data object.
  - Add `createdAt: serverTimestamp()` and `updatedAt: serverTimestamp()` to record timestamps.
- **Error Handling:**
  - Implement a `try...catch` block to wrap the Firestore data saving code.
  - In the `catch` block, log any errors to the console.
  - Return an error state from the Server Action (e.g., `{ error: 'Failed to save entry' }`) to be handled by the frontend.
- **Success State:**
  - Upon successful data saving to Firestore, log a success message to the console.
  - Return a success state from the Server Action (e.g., `{ success: true }`) to indicate successful operation to the frontend.
- **Revalidation:**
  - After successfully saving the entry, call `revalidatePath('/')` to trigger revalidation of the home page route (`/`) to ensure the diary entry overview is updated with the new entry.

## 5. Steps to Implement

1. **Open `saveDiaryEntry` Function:**
   - Open the file containing the `saveDiaryEntry` Server Action (e.g., `src/components/EntryForm.tsx` or `src/app/actions.ts`).
2. **Implement Firestore Data Saving Logic:**
   - Wrap the Firestore data saving code in a `try...catch` block.
   - Inside the `try` block, use `await addDoc(collection(db, "diaryEntries"), { ... });` to save the data.
   - Include all extracted form fields (from User Story 008.2) and `userId` in the data object.
   - Add `createdAt: serverTimestamp()` and `updatedAt: serverTimestamp()`.
   - Log success message and return `{ success: true }`.
     ```typescript
     // Inside saveDiaryEntry function, within try block
     try {
       const docRef = await addDoc(collection(db, "diaryEntries"), {
         userId: userId,
         foodEaten: foodEaten,
         description: description,
         emotions: emotions,
         location: location,
         company: company,
         behavior: behavior,
         skippedMeal: skippedMealBoolean,
         date: date,
         time: time,
         entryType: entryType,
         createdAt: serverTimestamp(),
         updatedAt: serverTimestamp(),
       });
       console.log("Document written with ID: ", docRef.id);
       revalidatePath('/'); // Revalidate home page
       return { success: true }; // Return success state
     } catch (error: any) { ... } // Catch block below
     ```
3. **Implement Error Handling:**
   - In the `catch` block, log the error: `console.error("Error adding document: ", error);`.
   - Return an error state: `return { error: 'Failed to save entry' };`.
     ```typescript
     // Inside saveDiaryEntry function, catch block
     catch (error: any) {
       console.error("Error adding document: ", error);
       return { error: 'Failed to save entry' }; // Return error state
     }
     ```
4. **Import `revalidatePath`:**
   - Ensure `revalidatePath` is imported from `next/cache`:
     ```typescript
     import { revalidatePath } from "next/cache";
     ```

## 6. Acceptance Criteria

- Firestore data saving logic is implemented in the `saveDiaryEntry` Server Action, correctly writing all form data and user ID to the `diaryEntries` collection.
- `createdAt` and `updatedAt` timestamps are added to each Firestore document.
- Robust error handling is implemented using a `try...catch` block to manage Firestore operation errors.
- Success and error states are returned from the Server Action, providing feedback to the frontend.
- `revalidatePath('/')` is called after successful data saving to revalidate the home page route.
- No errors during form submission and data saving process.

## 7. Notes

- This user story completes the implementation of the `saveDiaryEntry` Server Action, connecting the frontend form to the Firestore database.
- The next user story (009) will focus on implementing the diary entry overview screen to display the saved entries.
- Further enhancements like form validation, loading states, and UI feedback can be added in future iterations.
