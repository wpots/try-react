# User Story 012.2: Implement Save Entry Server Action - Part 2

## 1. Title

Enhance save entry server action with comprehensive validation, error handling, and user feedback.

## 2. Goal

To improve the save entry functionality with robust validation, trusted server-side auth checks, detailed error handling, user-friendly error messages, and better user feedback during the save process.

## 3. Description

As a developer, I need to enhance the save entry server action with comprehensive validation, proper error handling for various failure scenarios, and improved user feedback. This includes field validation, error message translation, and handling edge cases.

## 4. Technical Details

- **Validation:** Client-side and server-side validation
- **Error Types:** Authentication, validation, network, Firestore errors, token/session verification errors
- **Error Messages:** Translated error messages using next-intl
- **User Feedback:** Loading states, success messages, error toasts/notifications
- **Auth Security:** Server action must derive user identity from verified server auth context only

## 5. Steps to Implement

1. **Add Comprehensive Validation:**
   - In `EntryForm.tsx`, add validation function:
     ```typescript
     const validateForm = () => {
       const errors: Record<string, string> = {};
       
       if (!foodEaten.trim()) {
         errors.foodEaten = t('validation.foodEatenRequired');
       }
       if (!date) {
         errors.date = t('validation.dateRequired');
       }
       if (!time) {
         errors.time = t('validation.timeRequired');
       }
       if (!entryType) {
         errors.entryType = t('validation.entryTypeRequired');
       }
       
       return errors;
     };
     ```

2. **Update Server Action with Validation:**
   - In `saveDiaryEntry` server action, add server-side validation:
     ```typescript
     // Validate required fields
     if (!formData.foodEaten?.trim()) {
       return { success: false, error: 'VALIDATION_ERROR', field: 'foodEaten' };
     }
     if (!formData.date) {
       return { success: false, error: 'VALIDATION_ERROR', field: 'date' };
     }
     // ... more validations
     ```
   - Validate and normalize all complex fields (`emotions`, `behavior`, `entryType`, `location`, `company`).
   - Reject malformed arrays and unexpected enum values.
   - Return structured error results for client rendering.

3. **Add Error Type Handling:**
   - Handle different error types:
    - `NOT_AUTHENTICATED`: User not logged in
    - `INVALID_SESSION`: Session or ID token cannot be verified
    - `VALIDATION_ERROR`: Form validation failed
    - `NETWORK_ERROR`: Network/Firestore connection issue
    - `UNKNOWN_ERROR`: Unexpected error

4. **Add Translated Error Messages:**
   - Update `nl.json` and `en.json`:
     ```json
     {
       "validation": {
         "foodEatenRequired": "Food eaten is required",
         "dateRequired": "Date is required",
         "timeRequired": "Time is required",
         "entryTypeRequired": "Entry type is required"
       },
        "errors": {
          "notAuthenticated": "You must be logged in to save entries",
          "invalidSession": "Your session expired. Please sign in again.",
          "saveFailed": "Failed to save entry. Please try again.",
          "networkError": "Network error. Please check your connection.",
          "unknownError": "An unexpected error occurred."
       },
       "success": {
         "entrySaved": "Entry saved successfully!"
       }
     }
     ```

5. **Improve User Feedback:**
   - Add toast/notification component (or use simple alert for now)
   - Show success message after save
   - Show field-specific error messages
   - Show general error messages for server errors

6. **Add Retry Logic:**
   - For network errors, allow user to retry save
   - Add "Retry" button in error state

7. **Handle Edge Cases:**
   - Handle user signing out during form fill
   - Handle Firestore permission errors
   - Handle quota exceeded errors (if any)
   - Handle image upload failures

8. **Add Form Reset After Save:**
   - Clear form fields after successful save
   - Reset image upload state
   - Reset form validation errors

9. **Add Loading States:**
   - Show loading spinner during save (`isPending` from `useActionState`)
   - Disable form fields during save
   - Show "Saving..." message

10. **Test Error Scenarios:**
    - Test with missing required fields
    - Test with invalid data
    - Test without authentication
    - Test with invalid or expired session/token
    - Test with network offline
    - Test Firestore permission errors
    - Verify error messages are translated
    - Verify success message appears

## 6. Acceptance Criteria

- Comprehensive form validation implemented (client and server-side)
- Server auth verification errors are handled and surfaced to the user
- Field-specific validation error messages displayed
- Translated error messages for all error types
- Success message shown after save
- Loading states properly displayed
- Error handling for all error scenarios
- Form resets after successful save
- Retry logic for network errors (optional)
- Edge cases handled (sign out, permissions, etc.)
- User feedback is clear and helpful

## 7. Notes

- This completes the save entry functionality
- Consider adding optimistic updates for better UX
- Error messages should be user-friendly, not technical
- Validation should happen both client and server-side
- Consider adding form auto-save/draft functionality in future
- Success/error feedback should be accessible (ARIA announcements)
