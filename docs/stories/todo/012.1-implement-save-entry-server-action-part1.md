# User Story 012.1: Implement Save Entry Server Action - Part 1

## 1. Title

Create server action to save diary entries via Firestore REST API, using a verified Firebase ID token for server-side auth.

## 2. Goal

To implement a server action that saves diary entry data to Firestore, including all form fields and optional image information. Auth is resolved server-side from the caller's Firebase ID token — `userId` is never accepted from client form data.

## 3. Description

As a developer, I need to create a server action that takes typed diary entry data from the form and saves it to Firestore. The entry should include all fields (food eaten, emotions, location, company, description, behavior, date, time, entry type) and optional image URL and public_id. Both create and update are handled by the same action.

## 4. Technical Details

- **Server Action:** `saveDiaryEntryFromInput(input)` in `apps/food-diary/src/app/actions/saveDiaryEntryFromInput/`
- **Auth:** Caller passes their Firebase ID token; server decodes the UID from the JWT payload (`extractUidFromIdToken`). Firestore itself verifies the token and enforces security rules via Bearer auth.
- **Transport:** Firestore REST API via `restCreateDiaryEntry` / `restUpdateDiaryEntry` in `src/lib/firestore/rest-helpers.ts` — no Firebase Admin SDK needed.
- **Call site:** `useCoachChatPersistence` hook calls the action, obtains the ID token via `user.getIdToken()` before calling.
- **Loading/error state:** `isSaving` and `saveError` managed by `useCoachChatPersistence`, propagated via `useCoachChatController`.

## 5. Implementation (as built)

### `saveDiaryEntryFromInput` server action

Located at `apps/food-diary/src/app/actions/saveDiaryEntryFromInput/saveDiaryEntryFromInput.ts`:

- Extracts `userId` from the passed ID token via `extractUidFromIdToken`
- Returns `{ error: "User not authenticated" }` if token is missing or invalid
- Normalises optional `entryId` (strips `$undefined` sentinel from client)
- Calls `restUpdateDiaryEntry` for edits, `restCreateDiaryEntry` for new entries
- Returns `{ success: true }` on success

### `useCoachChatPersistence` hook

Located at `apps/food-diary/src/components/EntryForm/hooks/useCoachChatPersistence.ts`:

- Obtains the current user (or signs in anonymously for guest flows)
- Calls `user.getIdToken()` to get a fresh ID token
- Calls `saveDiaryEntryFromInput` with full typed payload
- Exposes `isSaving`, `saveError`, `persistEntry`

### Why not `useActionState` / `<form action>`

The entry form is a multi-step chat wizard with controlled React state, not a standard HTML form. Using `useActionState` would require serialising all wizard state into `FormData` on each step. The direct-call pattern from the hook is cleaner and more type-safe for this use case.

## 6. Acceptance Criteria

- [x] `saveDiaryEntryFromInput` server action created
- [x] Server action saves all form fields to Firestore
- [x] Optional image URL and public_id handled
- [x] Server action gets user ID from verified server auth context (ID token)
- [x] Server action never trusts `userId` from form input
- [x] Both create and update paths implemented
- [x] Loading state shown during save (`isSaving`)
- [x] Error handling: `saveError` shown in `CoachChatConfirmCard`
- [x] Success handling: `onComplete` -> `router.push("/dashboard")`
- [x] Entry is saved correctly to Firestore `diaryEntries` collection
- [ ] Server-side field validation with structured error response (see 012.2)
- [ ] `saveDiaryEntry` (FormData variant) removed — currently reads `userId` from client input (security issue)

## 7. Notes

- The old `saveDiaryEntry(formData: FormData)` action still exists but is unused by the UI. It reads `userId` from client `FormData` which is a security vulnerability — it must be removed (tracked as remaining work in 012.2).
- `extractUidFromIdToken` decodes the UID for query filters without cryptographic signature verification. Firestore REST enforces access rules using the Bearer token — this is intentional and no service account credentials are needed.
- Date/time is stored as ISO strings; Firestore REST handles server-side timestamps for `createdAt`/`updatedAt` via `restCreateDiaryEntry`.
