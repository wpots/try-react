# User Story 012.1: Implement Save Entry Server Action - Part 1

## 1. Title

Create server action to save diary entries to Firestore, including image URLs and all form fields.

## 2. Goal

To implement a server action that saves diary entry data to Firestore, including all form fields and optional image information. This is the first part of the save functionality, focusing on secure server-owned persistence and trusted user identity.

## 3. Description

As a developer, I need to create a server action that takes form data from the diary entry form and saves it to Firestore. The entry should include all fields (food eaten, emotions, location, company, description, behavior, skipped meal, date, time, entry type) and optional image URL and public_id.

## 4. Technical Details

- **Server Action:** `saveDiaryEntry(formData)` in `apps/food-diary/src/app/actions.ts`
- **Firestore Collection:** `diaryEntries`
- **Data Types:** Match Firestore data model from story 007
- **Timestamps:** Use Firestore `serverTimestamp()` for `createdAt` and `updatedAt`
- **User ID Authority:** Derive authenticated user ID on the server from a verified session or ID token.
- **Security Rule:** Never accept `userId` from client form data.
- **Form State:** Use `useActionState` in `EntryForm` with `<form action={formAction}>`.

## 5. Steps to Implement

1. **Create Save Entry Server Action:**
   - In `apps/food-diary/src/app/actions.ts`, create:
     ```typescript
     "use server";
     
     import { db, auth } from '@/lib/firebase';
     import { collection, addDoc, serverTimestamp } from 'firebase/firestore';
     
     export async function saveDiaryEntry(formData: {
       entryType: string;
       foodEaten: string;
       emotions: string[];
       location: string;
       company: string;
       description: string;
       behavior: string[];
       skippedMeal: boolean;
       date: string; // ISO date string
       time: string; // HH:mm format
     }) {
       try {
         const user = auth.currentUser;
         if (!user) {
           return { success: false, error: 'NOT_AUTHENTICATED' };
         }
         
         // Convert date string to Firestore Timestamp
         const entryDate = new Date(formData.date);
         
         const entryData = {
           userId: user.uid,
           entryType: formData.entryType,
           foodEaten: formData.foodEaten,
           emotions: formData.emotions,
           location: formData.location,
           company: formData.company,
           description: formData.description,
           behavior: formData.behavior,
           skippedMeal: formData.skippedMeal,
           date: Timestamp.fromDate(entryDate),
           time: formData.time,
           createdAt: serverTimestamp(),
           updatedAt: serverTimestamp(),
         };
         
         const docRef = await addDoc(collection(db, 'diaryEntries'), entryData);
         
         return {
           success: true,
           entryId: docRef.id,
         };
       } catch (error) {
         console.error('Error saving diary entry:', error);
         return {
           success: false,
           error: 'SAVE_FAILED',
           message: 'Failed to save entry. Please try again.',
         };
       }
     }
     ```

2. **Add Trusted Server Auth Resolution:**
   - Create a server-only auth helper (for example using Firebase Admin SDK).
   - Verify session cookie or ID token in the server action.
   - Resolve `userId` only from verified server auth context.
   - If auth is missing or invalid, return `NOT_AUTHENTICATED`.

3. **Update EntryForm to Use `useActionState`:**
   - In `EntryForm.tsx`, import `saveDiaryEntry`
   - Replace imperative `onSubmit` mutation logic with `useActionState`:
     ```typescript
     const [state, formAction, isPending] = useActionState(
       saveDiaryEntry,
       initialState,
     );

     return <Form action={formAction}>...</Form>;
     ```
   - Keep field state local where needed, but use action state as mutation source of truth.
   - Do not include `userId` in form payload.

4. **Add Loading State:**
   - Use `isPending` from `useActionState` for submit state.
   - Show loading indicator during save.
   - Disable form fields while pending.

5. **Add Success/Error Handling:**
   - Show success message after save
   - Redirect to entry overview page
   - Show error message if save fails
   - Handle authentication errors

6. **Add Form Validation (Basic):**
   - Validate required fields (foodEaten, date, time, entryType)
   - Show validation errors before submission
   - Prevent submission if validation fails

7. **Test Save Functionality:**
   - Fill out form with all fields
   - Submit form
   - Verify entry is saved to Firestore
   - Check that all fields are saved correctly
   - Verify timestamps are set
   - Test with image URL
   - Test without image
   - Test error handling (e.g., not authenticated)

## 6. Acceptance Criteria

- `saveDiaryEntry` server action created in `actions.ts`
- Server action saves all form fields to Firestore
- Server action handles optional image URL and public_id
- Server action uses `serverTimestamp()` for createdAt and updatedAt
- Server action gets user ID from verified server auth context
- Server action never trusts `userId` from form input
- EntryForm calls server action on submit
- EntryForm uses `useActionState` and `action={formAction}`
- Loading state shown during save
- Success handling: redirects to overview page
- Error handling: shows error messages
- Basic form validation implemented
- Entry is saved correctly to Firestore `diaryEntries` collection
- All fields match Firestore data model from story 007

## 7. Notes

- This is part 1 of save functionality - part 2 will add more validation and error handling
- Date conversion from string to Firestore Timestamp is important
- Server action should handle both guest and registered users
- If server-side token verification infrastructure is missing, add a small prerequisite task to set up secure auth context before implementing this story.
- Consider adding optimistic UI updates for better UX
- Error messages should be user-friendly and translated
- Form should prevent double-submission
