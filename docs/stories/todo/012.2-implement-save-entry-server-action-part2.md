# User Story 012.2: Implement Save Entry Server Action - Part 2

## 1. Title

Enhance save entry with server-side field validation, structured error handling, missing i18n keys, and visible form validation feedback.

## 2. Goal

Harden the save entry flow with proper field validation (server and client), complete translated error messages, and user-visible validation feedback in the traditional form. Also remove the insecure unused `saveDiaryEntry` FormData action.

## 3. Description

As a developer, I need to add server-side field validation to `saveDiaryEntryFromInput`, add missing i18n error/validation keys, and show field validation errors inline in the `TraditionalForm`. The old `saveDiaryEntry` FormData action (which reads `userId` from client input) must be deleted.

## 4. Technical Details

- **Server-side validation:** Add required field checks to `saveDiaryEntryFromInput` before writing to Firestore.
- **i18n:** Add missing keys to `en/entry/supporting.json` and `nl/entry/supporting.json`.
- **TraditionalForm field errors:** Show inline validation messages instead of silently blocking submit.
- **Cleanup:** Remove the unused `saveDiaryEntry` (FormData) action family.

## 5. Remaining items to implement

### 5.1 Remove insecure `saveDiaryEntry` (FormData)

Delete `apps/food-diary/src/app/actions/saveDiaryEntry/` and remove its export from `actions/index.ts`. The action reads `userId` from client-supplied `FormData` — it is unused by the UI and poses a security risk.

### 5.2 Server-side validation in `saveDiaryEntryFromInput`

Add field-level checks before the Firestore call, and extend `SaveDiaryEntryFromInputResult` with an `errorCode` discriminant:

```typescript
if (!input.foodEaten?.trim()) {
  return { success: false, errorCode: "VALIDATION_ERROR", field: "foodEaten" };
}
if (!input.date) {
  return { success: false, errorCode: "VALIDATION_ERROR", field: "date" };
}
if (!input.time) {
  return { success: false, errorCode: "VALIDATION_ERROR", field: "time" };
}
```

Also validate enum values for `entryType`, `location`, `company`, and array values for `emotions`, `behavior`. Reject and return structured errors for bad input.

### 5.3 Add missing i18n keys

Add to `messages/en/entry/supporting.json` and `messages/nl/entry/supporting.json`:

```json
"errors": {
  "invalidSession": "Your session expired. Please sign in again.",
  "networkError": "Network error. Please check your connection.",
  "unknownError": "An unexpected error occurred.",
  "validationFoodEaten": "Please enter what you ate or drank.",
  "validationDate": "Please enter a date.",
  "validationTime": "Please enter a time.",
  "validationEntryType": "Please select an entry type."
}
```

### 5.4 Visible validation errors in `TraditionalForm`

`TraditionalForm.handleSubmit` currently silently returns on missing required fields. Replace with:

- Local `validationErrors: Record<string, string>` state
- Set errors and show them inline below each required field
- Clear field error on change

## 6. Acceptance Criteria

- [ ] `saveDiaryEntry` (FormData variant) removed from codebase
- [ ] `saveDiaryEntryFromInput` rejects missing required fields with structured `errorCode`
- [ ] i18n keys added: `invalidSession`, `networkError`, `unknownError`, `validationFoodEaten`, `validationDate`, `validationTime`, `validationEntryType` (en + nl)
- [ ] `TraditionalForm` shows inline field validation errors
- [ ] Validation errors are cleared when the user corrects the input

## 7. Out of scope / deferred

- `useActionState` / `<form action>` pattern — the hook-based call is more appropriate for this wizard
- Success toast for the coach-chat flow — redirect is sufficient for now
- Retry button for network errors — lower priority
- Handling sign-out mid-form — lower priority
- Optimistic UI updates

## 8. Notes

- The `TraditionalForm` already has a success state (green ✓ shown after submit), so a success toast is not needed there.
- For the coach-chat flow, save success already triggers `router.push("/dashboard")`.
- `extractUidFromIdToken` is intentionally JWT-decode-only; Firestore REST enforces access via Bearer token.
